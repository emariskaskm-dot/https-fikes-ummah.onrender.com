// ========================================
// 1. STATE MANAGEMENT (Pengelolaan Data)
// ========================================
const state = {
    currentView: 'dashboard', // 'dashboard', 'module', 'results'
    selectedModule: null,
    scores: {}, // Menyimpan nilai ujian, contoh: { 1: 80, 2: 100 }
};

// ========================================
// 2. DATA (Konten Modul)
// ========================================
const modules = [
    {
        id: 1,
        title: "Pengantar Promosi Kesehatan",
        description: "Memahami konsep dasar, sejarah, dan prinsip-prinsip promosi kesehatan",
        duration: "45 menit",
        videoUrl: "https://www.youtube.com/watch?v=G2quVLcJVBk",
        color: "from-blue-400 to-blue-600",
        icon: "üìö",
        content: {
            definisi: "Promosi kesehatan adalah proses pemberdayaan masyarakat untuk meningkatkan kontrol terhadap kesehatan mereka sendiri melalui upaya preventif dan promotif.",
            tujuan: ["Meningkatkan kesadaran kesehatan masyarakat", "Mengubah perilaku hidup menjadi lebih sehat", "Menciptakan lingkungan yang mendukung kesehatan", "Memberdayakan individu dan komunitas"],
            sejarah: "Piagam Ottawa (1986) menjadi tonggak penting yang mendefinisikan 5 strategi utama promosi kesehatan.",
            prinsip: ["Melibatkan populasi secara keseluruhan", "Ditujukan pada determinan kesehatan", "Menggunakan berbagai pendekatan", "Partisipasi aktif masyarakat", "Pendekatan holistik dan intersektoral"],
            poin_penting: ["Promosi kesehatan lebih dari sekadar penyuluhan.", "Fokus pada pemberdayaan, bukan hanya perubahan perilaku individu.", "Lingkungan (sosial, fisik, ekonomi) adalah faktor kunci."],
            referensi: ["World Health Organization. (1986). The Ottawa Charter for Health Promotion.", "Nutbeam, D. (2000). Health literacy as a public health goal."]
        }
    },
    {
        id: 2,
        title: "Perilaku Kesehatan & Teori Perubahan",
        description: "Mempelajari berbagai teori yang menjelaskan mengapa orang berperilaku tertentu terkait kesehatan.",
        duration: "60 menit",
        videoUrl: "https://www.youtube.com/watch?v=fHIiX9x0L9A",
        color: "from-purple-400 to-pink-600",
        icon: "üß†",
        content: {
            definisi: "Perilaku kesehatan adalah tindakan yang dilakukan individu, kelompok, atau masyarakat yang berkaitan dengan pemeliharaan dan peningkatan kesehatan.",
            teori_utama: ["Health Belief Model (HBM)", "Theory of Planned Behavior (TPB)", "Social Cognitive Theory (SCT)", "Transtheoretical Model (Stages of Change)"],
            poin_penting: ["Tidak ada satu teori yang sempurna untuk menjelaskan semua perilaku kesehatan.", "Pemahaman terhadap determinan perilaku sangat penting.", "Self-efficacy (rasa percaya diri) adalah prediktor kuat dari perubahan perilaku."],
            studi_kasus: "Sebuah program untuk meningkatkan penggunaan kondom di kalangan remaja menggunakan Social Cognitive Theory. Program ini tidak hanya memberikan informasi, tetapi juga mendemonstrasikan cara penggunaan yang benar (observational learning), mengundang tokoh idola remaja untuk berbicara (modeling), dan melakukan latihan peran untuk meningkatkan self-efficacy remaja dalam menolak ajakan seks tidak aman.",
            kuis: [
                { pertanyaan: "Teori mana yang menekankan pada keyakinan akan kemampuan diri (self-efficacy)?", pilihan: ["HBM", "TPB", "SCT", "Stages of Change"], jawabanBenar: 2 },
                { pertanyaan: "Apa itu 'stages of change'?", pilihan: ["Model yang menjelaskan tahapan perubahan perilaku", "Nama dari sebuah organisasi kesehatan", "Jenis intervensi komunitas", "Teori tentang kepercayaan"], jawabanBenar: 0 }
            ]
        }
    },
    {
        id: 3,
        title: "Komunikasi Efektif dalam Promosi Kesehatan",
        description: "Mengasah kemampuan menyampaikan pesan kesehatan yang persuasif, jelas, dan berdampak.",
        duration: "50 menit",
        videoUrl: "https://www.youtube.com/watch?v=Ci7G7sTj-9A",
        color: "from-green-400 to-teal-600",
        icon: "üí¨",
        content: {
            definisi: "Komunikasi kesehatan adalah proses strategis untuk menyampaikan pesan kesehatan kepada publik dengan tujuan mempengaruhi pengetahuan, sikap, dan perilaku.",
            teknik_persuasi: ["Appeal to Emotion (Daya Tarik Emosional)", "Social Proof (Bukti Sosial)", "Authority (Kewenangan)", "Scarcity (Kelangkaan)"],
            kuis: [
                { pertanyaan: "Apa tujuan utama dari komunikasi kesehatan yang persuasif?", pilihan: ["Memberikan informasi sebanyak-banyaknya", "Mempengaruhi pengetahuan, sikap, dan perilaku", "Menghibur audiens", "Mendapatkan popularitas"], jawabanBenar: 1 },
                { pertanyaan: "Teknik persuasi mana yang paling efektif jika audiens Anda adalah remaja yang sangat mengidolakan seorang atlet?", pilihan: ["Appeal to Emotion", "Social Proof", "Authority", "Scarcity"], jawabanBenar: 2 }
            ],
            materi_tambahan: [
                { judul: "Ebook: Panduan Praktis Public Speaking untuk Tenaga Kesehatan", url: "#" },
                { judul: "Cheat Sheet: Template Desain Media Sosial Kesehatan", url: "#" }
            ]
        }
    }
];

// ========================================
// 3. RENDERING FUNCTIONS (Pembuat Tampilan)
// ========================================

function renderApp() {
    const app = document.getElementById('app');
    if (!app) return;

    // Hancurkan chart sebelumnya jika ada untuk mencegah duplikasi saat pindah halaman
    if (window.myPieChart) {
        window.myPieChart.destroy();
    }

    switch (state.currentView) {
        case 'module':
            app.innerHTML = renderModule();
            break;
        case 'results':
            app.innerHTML = renderResultsView();
            // Panggil fungsi untuk menggambar chart setelah HTML dirender
            setTimeout(drawResultsChart, 0);
            break;
        default: // 'dashboard'
            app.innerHTML = renderDashboard();
            break;
    }
}

function renderDashboard() {
    const moduleCards = modules.map(module => {
        const isCompleted = state.scores.hasOwnProperty(module.id);
        const score = state.scores[module.id];
        const statusText = isCompleted ? `‚úì Selesai (Nilai: ${score})` : 'Mulai Belajar';
        const statusColor = isCompleted ? 'text-green-600' : 'text-blue-600';

        return `
            <div onclick="selectModule(${module.id})" class="backdrop-blur-xl bg-white/70 rounded-3xl p-6 shadow-lg border border-white/50 cursor-pointer hover:scale-105 transition-all">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${module.color} flex items-center justify-center shadow-md mb-4">
                    <span class="text-3xl">${module.icon}</span>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">${module.title}</h3>
                <p class="text-sm text-gray-600 mb-4">${module.description}</p>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-500">‚è± ${module.duration}</span>
                    <span class="${statusColor} font-semibold">${statusText}</span>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50">
            <div class="backdrop-blur-xl bg-white/80 border-b border-gray-200/50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <h1 class="text-3xl font-bold text-gray-900">Dashboard Pembelajaran</h1>
                    <p class="text-gray-600">Pilih modul untuk memulai belajar.</p>
                </div>
            </div>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kartu Lihat Hasil -->
                    <div onclick="state.currentView = 'results'; renderApp();" class="backdrop-blur-xl bg-gradient-to-br from-indigo-100 to-purple-100 rounded-3xl p-6 shadow-lg border border-white/50 cursor-pointer hover:scale-105 transition-all">
                        <div class="text-5xl mb-4 text-center">üìä</div>
                        <h3 class="text-lg font-bold text-gray-900 text-center">Lihat Hasil Ujian</h3>
                        <p class="text-sm text-gray-600 text-center mt-2">Pantau perkembangan belajar Anda</p>
                    </div>
                    ${moduleCards}
                </div>
            </div>
        </div>
    `;
}

function renderModule() {
    const module = state.selectedModule;
    if (!module) return '';

    // ... (Sisipkan seluruh kode fungsi renderModule yang panjang di sini) ...
    // Kode ini sama persis dengan yang ada di jawaban sebelumnya, yang menampilkan konten modul, kuis, dll.
    // Untuk menghemat ruang, saya tidak menuliskannya ulang, tapi Anda harus menyalinnya dari jawaban sebelumnya.
    // Pastikan tombol "Tandai Selesai" memanggil fungsi completeModule()
    // <button onclick="completeModule()" ...
    return `
        <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50">
            <!-- Header dan Konten Modul -->
            <div class="backdrop-blur-xl bg-white/80 border-b border-gray-200/50 sticky top-0 z-50">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center h-16">
                        <button onclick="goToDashboard()" class="text-blue-600 hover:text-blue-700 font-semibold">‚Äπ Dashboard</button>
                    </div>
                </div>
            </div>
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="backdrop-blur-xl bg-white/70 rounded-3xl p-8 shadow-xl border border-white/50 mb-6">
                    <!-- ... (seluruh konten modul Anda) ... -->
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">${module.title}</h1>
                    <p class="text-gray-600">${module.description}</p>
                    <!-- ... tempatkan semua konten (definisi, tujuan, kuis, dll) di sini ... -->
                    <!-- Contoh Kuis -->
                    ${module.content.kuis ? `
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6 border border-purple-100">
                            <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center"><span class="text-2xl mr-2">üß†</span> Kuis Pemahaman</h3>
                            <div id="quiz-container" class="space-y-4">
                                ${module.content.kuis.map((q, i) => `
                                    <div class="bg-white/70 rounded-xl p-4">
                                        <p class="font-semibold text-gray-800 mb-2">${i + 1}. ${q.pertanyaan}</p>
                                        <div class="space-y-1">${q.pilihan.map((p, j) => `
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="radio" name="question-${i}" value="${j}" class="text-purple-600">
                                                <span class="text-gray-700">${p}</span>
                                            </label>
                                        `).join('')}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div id="quiz-result" class="mt-4 p-4 rounded-xl hidden"></div>
                        </div>
                    ` : ''}
                </div>
                <button onclick="completeModule()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-3xl p-6 shadow-xl hover:scale-105 transition-all font-semibold text-lg">‚úì Tandai Selesai & Lihat Hasil</button>
            </div>
        </div>
    `;
}

function renderResultsView() {
    const moduleIds = Object.keys(state.scores);
    if (moduleIds.length === 0) {
        return `
            <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50 flex items-center justify-center">
                <div class="text-center p-8 backdrop-blur-xl bg-white/70 rounded-3xl shadow-xl">
                    <div class="text-6xl mb-4">üìä</div>
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">Belum Ada Hasil Ujian</h1>
                    <p class="text-gray-600 mb-6">Anda belum menyelesaikan ujian dari modul mana pun.</p>
                    <button onclick="goToDashboard()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-blue-700 transition-all">Kembali ke Dashboard</button>
                </div>
            </div>
        `;
    }

    const labels = [];
    const data = [];
    const tableRows = moduleIds.map(id => {
        const module = modules.find(m => m.id == id);
        const score = state.scores[id];
        labels.push(module.title);
        data.push(score);
        const status = score >= 80 ? 'Lulus' : 'Belum Lulus';
        const statusColor = score >= 80 ? 'text-green-600' : 'text-red-600';
        return `<tr class="border-b border-gray-200"><td class="py-3 px-4 text-gray-900">${module.title}</td><td class="py-3 px-4 text-center font-semibold">${score}</td><td class="py-3 px-4 text-center font-semibold ${statusColor}">${status}</td></tr>`;
    }).join('');

    return `
        <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50">
            <div class="backdrop-blur-xl bg-white/80 border-b border-gray-200/50 sticky top-0 z-50">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center h-16">
                        <button onclick="goToDashboard()" class="text-blue-600 hover:text-blue-700 font-semibold">‚Äπ Dashboard</button>
                    </div>
                </div>
            </div>
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="backdrop-blur-xl bg-white/70 rounded-3xl p-8 shadow-xl border border-white/50">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Hasil Ujian Anda</h1>
                    <p class="text-gray-600 text-center mb-8">Berikut adalah ringkasan nilai dari semua ujian yang telah Anda selesaikan.</p>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div class="flex justify-center"><div style="position:relative;height:300px;width:300px;"><canvas id="resultsPieChart"></canvas></div></div>
                        <div><div class="overflow-hidden rounded-2xl border border-gray-200"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="py-3 px-4 text-left">Modul</th><th class="py-3 px-4 text-center">Nilai</th><th class="py-3 px-4 text-center">Status</th></tr></thead><tbody>${tableRows}</tbody></table></div></div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ========================================
// 4. LOGIC & EVENT HANDLERS (Logika Bisnis)
// ========================================

function selectModule(id) {
    state.selectedModule = modules.find(m => m.id === id);
    state.currentView = 'module';
    renderApp();
}

function goToDashboard() {
    state.selectedModule = null;
    state.currentView = 'dashboard';
    renderApp();
}

function completeModule() {
    const module = state.selectedModule;
    if (!module) return;

    let score = 100; // Default nilai jika tidak ada kuis
    if (module.content.kuis) {
        score = checkQuizAnswers();
        const resultDiv = document.getElementById('quiz-result');
        resultDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
        if (score >= 80) {
            resultDiv.classList.add('bg-green-100', 'text-green-800');
            resultDiv.innerHTML = `<strong>Selamat!</strong> Anda lulus dengan nilai ${score}.`;
        } else {
            resultDiv.classList.add('bg-yellow-100', 'text-yellow-800');
            resultDiv.innerHTML = `Anda mendapatkan nilai ${score}. Pelajari kembali materi untuk pemahaman yang lebih baik.`;
        }
    }

    // Simpan nilai
    state.scores[module.id] = score;

    // Tunggu sebentar, lalu arahkan ke halaman hasil
    setTimeout(() => {
        state.currentView = 'results';
        renderApp();
    }, 2000);
}

function checkQuizAnswers() {
    const module = state.selectedModule;
    if (!module || !module.content.kuis) return 0;
    let correct = 0;
    module.content.kuis.forEach((question, qIndex) => {
        const selectedOption = document.querySelector(`input[name="question-${qIndex}"]:checked`);
        if (selectedOption && parseInt(selectedOption.value) === question.jawabanBenar) {
            correct++;
        }
    });
    return Math.round((correct / module.content.kuis.length) * 100);
}

function drawResultsChart() {
    const ctx = document.getElementById('resultsPieChart');
    if (!ctx) return;
    const moduleIds = Object.keys(state.scores);
    const labels = moduleIds.map(id => modules.find(m => m.id == id).title);
    const data = moduleIds.map(id => state.scores[id]);
    window.myPieChart = new Chart(ctx, {
        type: 'pie', data: {
            labels: labels, datasets: [{
                label: 'Nilai Ujian', data: data,
                backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(75, 192, 192, 0.8)'],
                borderWidth: 1
            }]
        }, options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15 } },
                tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed} Poin` } }
            }
        }
    });
}

// ========================================
// 5. INITIALIZE (Jalankan Aplikasi)
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    renderApp();
});
